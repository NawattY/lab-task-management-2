generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
//
// ROLES (RBAC)
//
model Role {
  id          String   @id @default(uuid()) @map("id")
  name        String   @unique @map("name") // ADMIN, STAFF, USER
  description String?  @map("description")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  users User[]

  @@map("role")
}

//
// USERS (identity)
//
model User {
  id         String    @id @default(uuid()) @map("id")
  roleId     String    @map("role_id")
  employeeNo String    @unique @map("employee_no")
  mobile     String?   @unique @map("mobile")
  email      String?   @unique @map("email")
  firstName  String?   @map("first_name")
  lastName   String?   @map("last_name")
  password   String?   @map("password")
  avatar     String?   @map("avatar")
  status     String    @default("pending") @map("status")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  role           Role                @relation(fields: [roleId], references: [id])
  sessions       UserSession[]
  passwordResets UserPasswordReset[]

  @@index([mobile])
  @@index([status])
  @@index([roleId])
  @@map("user")
}

//
// Refresh token storage
//
model UserSession {
  id               String    @id @default(uuid()) @map("id")
  userId           String    @map("user_id")
  refreshTokenHash String    @map("refresh_token_hash")
  userAgent        String?   @map("user_agent")
  ipAddress        String?   @map("ip_address") @db.Inet
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt        DateTime  @map("expires_at") @db.Timestamptz(6)
  replacedAt       DateTime? @map("replaced_at") @db.Timestamptz(6)
  revokedAt        DateTime? @map("revoked_at") @db.Timestamptz(6)
  lastUsedAt       DateTime? @map("last_used_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt], map: "idx_user_sessions_active")
  @@map("user_session")
}

//
// Password Reset
//
model UserPasswordReset {
  id         String   @id @default(uuid()) @map("id")
  userId     String   @map("user_id")
  resetId    String   @unique @map("reset_id")
  secretHash String   @map("secret_hash")
  expiresAt  DateTime @map("expires_at") @db.Timestamptz(6)
  isUsed     Boolean  @default(false) @map("is_used")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resetId])
  @@map("user_password_reset")
}
